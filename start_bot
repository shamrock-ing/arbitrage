#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="${ROOT_DIR}/.venv"
PYTHON_BIN="${PYTHON_BIN:-/usr/bin/python3}"
PY_BIN="${VENV_DIR}/bin/python"
PIP_BIN="${VENV_DIR}/bin/pip"
PLAYWRIGHT_BIN="${VENV_DIR}/bin/playwright"

pause_if_tty() {
  if [[ -t 1 ]]; then
    echo
    read -n1 -rsp "Press any key to close..." _
    echo
  fi
}

trap 'echo "[ERROR] The start script failed. See messages above."; pause_if_tty' ERR

echo "==> Using Python: ${PYTHON_BIN}"
"${PYTHON_BIN}" -V || { echo "[ERROR] Python not found at ${PYTHON_BIN}"; exit 1; }

if [[ ! -d "${VENV_DIR}" ]]; then
  echo "==> Creating virtual environment at ${VENV_DIR}"
  if ! "${PYTHON_BIN}" -m venv "${VENV_DIR}"; then
    echo "[WARN] python -m venv failed. Trying ensurepip bootstrap..."
    "${PYTHON_BIN}" -m ensurepip --upgrade || true
    "${PYTHON_BIN}" -m venv "${VENV_DIR}"
  fi
fi

if [[ ! -x "${PIP_BIN}" ]]; then
  echo "[ERROR] venv pip not found at ${PIP_BIN}"; exit 1
fi

echo "==> Upgrading pip/setuptools/wheel"
"${PIP_BIN}" install --upgrade pip setuptools wheel

echo "==> Installing Python dependencies"
"${PIP_BIN}" install requests playwright beautifulsoup4

if [[ ! -x "${PLAYWRIGHT_BIN}" ]]; then
  echo "[ERROR] Playwright CLI not found in venv at ${PLAYWRIGHT_BIN}"; exit 1
fi

echo "==> Installing Playwright browsers (Chromium)"
"${PLAYWRIGHT_BIN}" install chromium

echo "==> Running bot"
"${PY_BIN}" "${ROOT_DIR}/main.py" || true

pause_if_tty